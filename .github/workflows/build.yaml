name: Build and Publish

on:
  pull_request:
  push:
    branches: [ main ]
    tags:
      - 'v*'

jobs:
  build:
    name: ğŸ”¨ Build
    runs-on: macos-26

    env:
      CI: true

    steps:
    - name: ğŸ›’ Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 #Nerdbank needs full clone
    - name: ğŸ Select Xcode 26.1
      run: sudo xcode-select -s /Applications/Xcode_26.1.app/Contents/Developer
    - name: ğŸ¥… Setup .NET
      uses: actions/setup-dotnet@v5

    - name: ğŸ¥… .NET Workload Install
      run: dotnet workload install maui android ios maccatalyst

    - name: 'ğŸ”¢ Setup Variables - Version'
      uses: dotnet/nbgv@master
      with:
        setAllVars: true

    - name: ğŸ§ª Run Tests
      run: dotnet test ./Tests/Tests.csproj --configuration Release --logger "trx;LogFileName=test-results.trx"
      continue-on-error: true
      env:
        # Tests require API keys - will be marked as inconclusive if not provided
        AppSettings__ApiKeyV1: ${{ secrets.AppSettings__ApiKeyV1 }}
        AppSettings__ApiKeyV2: ${{ secrets.AppSettings__ApiKeyV2 }}
        TestSettings__ProjectId: ${{ secrets.TestSettings__ProjectId }}
        TestSettings__CustomerId: ${{ secrets.TestSettings__CustomerId }}

    - name: ğŸ“Š Test Report
      uses: dorny/test-reporter@v2
      if: always()
      with:
        name: Test Results
        path: '**/test-results.trx'
        reporter: dotnet-trx
        fail-on-error: false

    - name: ğŸ“¦ Build + Pack
      run: |
        dotnet build -m:1 -t:DownloadNativeDependencies ./macios/RevenueCat.MaciOS.Binding/RevenueCat.MaciOS.Binding.csproj
        dotnet pack -m:1 -c Release -p:PublicRelease=${{ env.NBGV_PublicRelease }} -bl:${{ github.workspace}}/artifacts/Plugin.RevenueCat.Android.Binding.binlog ./android/RevenueCat.Android.Binding/RevenueCat.Android.Binding.csproj
        dotnet pack -m:1 -c Release -p:PublicRelease=${{ env.NBGV_PublicRelease }} -bl:${{ github.workspace}}/artifacts/Plugin.RevenueCat.MaciOS.Binding.binlog ./macios/RevenueCat.MaciOS.Binding/RevenueCat.MaciOS.Binding.csproj
        dotnet pack -m:1 -c Release -p:PublicRelease=${{ env.NBGV_PublicRelease }} -bl:${{ github.workspace}}/artifacts/Plugin.RevenueCat.Core.binlog ./Plugin.RevenueCat.Core/Plugin.RevenueCat.Core.csproj
        dotnet pack -m:1 -c Release -p:PublicRelease=${{ env.NBGV_PublicRelease }} -bl:${{ github.workspace}}/artifacts/Plugin.RevenueCat.Api.binlog ./Plugin.RevenueCat.Api/Plugin.RevenueCat.Api.csproj
        dotnet pack -m:1 -c Release -p:PublicRelease=${{ env.NBGV_PublicRelease }} -bl:${{ github.workspace}}/artifacts/Plugin.RevenueCat.binlog ./Plugin.RevenueCat/Plugin.RevenueCat.csproj

    - name: â¬†ï¸ Packages
      uses: actions/upload-artifact@v5
      with:
        name: Packages
        path: |
          ./artifacts/package/release/*.nupkg
          ./artifacts/package/release/*.snupkg

    - name: â¬†ï¸ Logs
      if: always()
      uses: actions/upload-artifact@v5
      with:
        name: Logs
        path: |
          ./artifacts/*.binlog

  publish:
    name: ğŸ“¢ Publish
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.event.ref, 'refs/tags/v')
    steps:
      - name: â¬‡ï¸ Packages
        uses: actions/download-artifact@v5
        with:
          name: Packages
      - name: ğŸ¥… Setup .NET
        uses: actions/setup-dotnet@v5
      - name: ğŸš¢ Push NuGet
        run: |
          dotnet nuget push *.nupkg --source https://api.nuget.org/v3/index.json --api-key ${{ secrets.NUGET_ORG_API_KEY }} --skip-duplicate
